/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/Control","sap/ui/integration/util/CardManifest","sap/ui/integration/util/ServiceManager","sap/base/Log","sap/f/cards/Data","sap/f/CardRenderer"],function(q,C,a,S,L,D,b){"use strict";var M={TYPE:"/sap.card/type",DATA:"/sap.card/data",HEADER:"/sap.card/header",CONTENT:"/sap.card/content",SERVICES:"/sap.ui5/services",APP_TYPE:"/sap.app/type"};var c=C.extend("sap.ui.integration.widgets.Card",{metadata:{library:"sap.ui.integration",interfaces:["sap.f.ICard"],properties:{manifest:{type:"any",defaultValue:""},width:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"100%"},height:{type:"sap.ui.core.CSSSize",group:"Appearance",defaultValue:"auto"}},aggregations:{_header:{type:"sap.f.cards.IHeader",multiple:false,visibility:"hidden"},_content:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}},associations:{hostConfigurationId:{}}},renderer:b});c.prototype.exit=function(){if(this._oCardManifest){this._oCardManifest.destroy();this._oCardManifest=null;}if(this._oServiceManager){this._oServiceManager.destroy();this._oServiceManager=null;}};c.prototype.setManifest=function(v){this.setBusy(true);this.setProperty("manifest",v,true);if(typeof v==="string"&&v!==""){this._oCardManifest=new a();this._oCardManifest.load({manifestUrl:v}).then(function(){this._applyManifestSettings();}.bind(this));}else if(typeof v==="object"&&!q.isEmptyObject(v)){this._oCardManifest=new a(v);this._applyManifestSettings();}return this;};c.prototype._applyManifestSettings=function(){if(this._oCardManifest.get(M.APP_TYPE)!=="card"){L.error("sap.app/type entry in manifest is not 'card'");}this._registerServices();this._setData();this._setHeaderFromManifest();this._setContentFromManifest();};c.prototype._setData=function(){var d=this._oCardManifest.get(M.DATA);if(!d){return;}this._oDataPromise=new Promise(function(r,e){var R=d.request;if(d.json){r({json:d.json,path:d.path});return;}if(R){D.fetch(R).then(function(f){r({json:f,path:d.path});}).catch(function(E){e(E);});}});};c.prototype._registerServices=function(){var s=this._oCardManifest.get(M.SERVICES);if(!s){return;}if(!this._oServiceManager){this._oServiceManager=new S(s);}var h=this._oCardManifest.get(M.HEADER);var o=this._oCardManifest.get(M.CONTENT);var H=h&&h.actions&&h.actions[0].service&&h.actions[0].type==="Navigation";var d=o&&o.item&&o.item.actions&&o.item.actions[0].service&&o.item.actions[0].type==="Navigation";var e=o&&o.data&&o.data.service;if(H){this._oServiceManager.registerService(h.actions[0].service,"sap.ui.integration.services.Navigation");}if(d){this._oServiceManager.registerService(o.item.actions[0].service,"sap.ui.integration.services.Navigation");}if(e){this._oServiceManager.registerService(o.data.service,"sap.ui.integration.services.Data");}};c.prototype.getCardHeader=function(){return this.getAggregation("_header");};c.prototype.getCardContent=function(){return this.getAggregation("_content");};c.prototype._setHeaderFromManifest=function(){var h=this._oCardManifest.get(M.HEADER);if(!h){L.error("Card header is mandatory!");return;}if(h.type==="Numeric"){sap.ui.require(["sap/f/cards/NumericHeader"],this._setCardHeaderFromManifest.bind(this));}else{sap.ui.require(["sap/f/cards/Header"],this._setCardHeaderFromManifest.bind(this));}};c.prototype._setContentFromManifest=function(){var s=this._oCardManifest.get(M.TYPE);if(!s){L.error("Card type property is mandatory!");return;}switch(s.toLowerCase()){case"list":sap.ui.require(["sap/f/cards/ListContent"],this._setCardContentFromManifest.bind(this));break;case"table":sap.ui.require(["sap/f/cards/TableContent"],this._setCardContentFromManifest.bind(this));break;case"object":sap.ui.require(["sap/f/cards/ObjectContent"],this._setCardContentFromManifest.bind(this));break;case"analytical":sap.ui.getCore().loadLibrary("sap.viz",{async:true}).then(function(){sap.ui.require(["sap/f/cards/AnalyticalContent"],this._setCardContentFromManifest.bind(this));}.bind(this)).catch(function(){L.error("Analytical type card is not available with this distribution");});break;case"timeline":sap.ui.getCore().loadLibrary("sap.suite.ui.commons",{async:true}).then(function(){sap.ui.require(["sap/f/cards/TimelineContent"],this._setCardContentFromManifest.bind(this));}.bind(this)).catch(function(){L.error("Timeline type card is not available with this distribution");});break;default:L.error(s.toUpperCase()+" Card type is not supported");}};c.prototype._setCardHeaderFromManifest=function(d){var o=q.extend(true,{},this._oCardManifest.get(M.HEADER));var h=d.create(o);h.attachEvent("_updated",function(){this.fireEvent("_headerUpdated");}.bind(this));if(!o.data||(o.data&&o.data.json)){var e={onAfterRendering:function(){this.fireEvent("_headerUpdated");h.removeEventDelegate(e);}};h.addEventDelegate(e,this);}if(Array.isArray(o.actions)&&o.actions.length>0){this._setCardHeaderActions(h,o.actions);}this.setAggregation("_header",h);if(this._oDataPromise){this._oDataPromise.then(function(f){if(h.isA("sap.f.cards.NumericHeader")){sap.f.cards.NumericHeader._handleData(h,f);}else{sap.f.cards.Header._handleData(h,f);}}).catch(function(E){});}};c.prototype._setCardHeaderActions=function(h,A){var o;for(var i=0;i<A.length;i++){if(A[i].type==="Navigation"&&A[i].enabled){o=A[i];break;}}if(!o){return;}if(o.service){h.attachPress(function(){this._oServiceManager.getService("sap.ui.integration.services.Navigation").then(function(n){if(n){n.navigate(o.parameters);}}).catch(function(){L.error("Navigation service unavailable");});}.bind(this));}else if(o.url){h.attachPress(function(){window.open(o.url,o.target||"_blank");});}h.addStyleClass("sapFCardHeaderClickable");};c.prototype.onBeforeRendering=function(){var s=this.getHostConfigurationId();if(s){this.addStyleClass(s.replace(/-/g,"_"));}};c.prototype._setCardContentFromManifest=function(d){var s=this._oCardManifest.get(M.CONTENT);if(!s){this.setBusy(false);return;}var o={configuration:q.extend(true,{},s)};if(this._oServiceManager){o.serviceManager=this._oServiceManager;}var e=new d(o);e.attachEvent("_updated",function(){this.fireEvent("_contentUpdated");}.bind(this));this.setAggregation("_content",e);if(this._oDataPromise){this._oDataPromise.then(function(f){e._setData(f);}).catch(function(E){});}this.setBusy(false);};return c;});
